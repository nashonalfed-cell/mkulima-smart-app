let language = "sw";
let voiceAnswerEnabled = false;
let currentCrop = "";
let cropsDataDB = {};

/* =========================
   1. PAKIA DATA YA JSON
========================= */
async function loadCropsData() {
    try {
        const response = await fetch('crops.json');
        cropsDataDB = await response.json();
        console.log("Database ya mazao imepakiwa kikamilifu!");
    } catch (error) {
        console.error("Hitilafu: Haikuweza kupata crops.json. Hakikisha jina la faili ni sahihi GitHub.", error);
    }
}

// Inapakia data mara tu app inapofunguka
loadCropsData();

/* =========================
   2. TAFUTA MAELEZO YA ZAO
========================= */
async function generateData() {
    const userInput = document.getElementById("userCrop").value.trim().toLowerCase();
    if (!userInput) {
        alert(language === "sw" ? "Tafadhali andika jina la zao!" : "Please enter a crop name!");
        return;
    }

    currentCrop = userInput;
    document.getElementById("loadingSpinner").style.display = "inline-block";
    document.getElementById("cropCard").style.display = "none";

    // Set Title
    document.getElementById("cropTitle").innerText = currentCrop.toUpperCase();

    // JARIBU KUPATA DATA KUTOKA JSON KWANZA
    const localData = cropsDataDB[currentCrop] ? cropsDataDB[currentCrop][language] : null;

    /* Wikipedia API kwa maelezo ya ziada */
    try {
        const wikiURL = `https://en.wikipedia.org/api/rest_v1/page/summary/${currentCrop}`;
        const res = await fetch(wikiURL);
        const wikiData = await res.json();
        
        // Kama zao lipo kwenye JSON yetu, tumia hiyo kwanza, la sivyo tumia Wikipedia
        if (localData) {
            document.getElementById("wikiInfo").innerText = `${localData.planting}. ${localData.fertilizer}. ${localData.schedule}.`;
        } else {
            document.getElementById("wikiInfo").innerText = wikiData.extract || (language === "sw" ? "Maelezo hayajapatikana." : "Info not found.");
        }
    } catch {
        document.getElementById("wikiInfo").innerText = localData ? localData.planting : "Imeshindikana kupata taarifa mtandaoni.";
    }

    /* Picha - Inatumia Source.Unsplash au Image kutoka JSON */
    const img = document.getElementById("cropImage");
    img.src = localData && localData.image ? localData.image : `https://loremflickr.com/800/500/${currentCrop},agriculture`;
    
    img.onload = () => {
        document.getElementById("loadingSpinner").style.display = "none";
        document.getElementById("cropCard").style.display = "block";
    };
}

/* =========================
   3. AI QUESTION LOGIC (SMART)
========================= */
function askAI() {
    const q = document.getElementById("aiQuestion").value.toLowerCase();
    if (!q || !currentCrop) return;

    let answer = "";
    const info = cropsDataDB[currentCrop] ? cropsDataDB[currentCrop][language] : null;

    if (info) {
        if (q.includes("kupanda") || q.includes("msimu")) answer = info.planting;
        else if (q.includes("mbolea")) answer = info.fertilizer;
        else if (q.includes("maji") || q.includes("umwagiliaji")) answer = info.schedule;
        else if (q.includes("kuvuna")) answer = info.harvest;
        else if (q.includes("faida") || q.includes("soko")) answer = info.benefits_market;
        else if (q.includes("changamoto") || q.includes("magonjwa")) answer = info.challenges;
        else answer = language === "sw" ? `Kwa zao la ${currentCrop}, naweza kukupa ushauri wa kupanda, mbolea, na kuvuna.` : `For ${currentCrop}, I can advise on planting, fertilizer, and harvesting.`;
    } else {
        answer = language === "sw" ? "Samahani, sina data ya kina ya zao hili, lakini fanya utafiti wa udongo kwanza." : "Sorry, I don't have deep data for this crop yet.";
    }

    document.getElementById("aiAnswer").style.display = "block";
    typeEffect(document.getElementById("aiText"), answer);

    if (voiceAnswerEnabled) speak(answer);
}

/* =========================
   4. UTAMBUZI WA SAUTI (VOICE)
========================= */
function startVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("Browser yako hai-support sauti");
        return;
    }

    const rec = new SpeechRecognition();
    rec.lang = language === "sw" ? "sw-TZ" : "en-US";

    rec.onresult = e => {
        document.getElementById("aiQuestion").value = e.results[0][0].transcript;
        askAI();
    };
    rec.start();
}

function speak(text) {
    const s = new SpeechSynthesisUtterance(text);
    s.lang = language === "sw" ? "sw-TZ" : "en-US";
    window.speechSynthesis.speak(s);
}

function toggleVoiceAnswer() {
    voiceAnswerEnabled = !voiceAnswerEnabled;
    document.getElementById("voiceStatus").innerText = voiceAnswerEnabled ? "ON" : "OFF";
}

/* =========================
   5. MENGINEYO (UTILITIES)
========================= */
function typeEffect(el, text) {
    el.innerText = "";
    let i = 0;
    const t = setInterval(() => {
        el.innerText += text.charAt(i);
        i++;
        if (i >= text.length) clearInterval(t);
    }, 30);
}

function switchLanguage() {
    language = language === "sw" ? "en" : "sw";
    const msg = language === "sw" ? "Lugha imebadilishwa kuwa Kiswahili" : "Language switched to English";
    alert(msg);
}

